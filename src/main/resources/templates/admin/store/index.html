<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/admin/template}">
<head>
    <meta charset="UTF-8">
    <title>Bán hàng tại quầy</title>
    <link rel="stylesheet" href="/admin/store/style.css">
    <style>
        .search-container {
            position: relative;
            width: 300px;
        }

        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }



        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .suggestion-image {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 8px;
        }

        .suggestion-text {
            font-size: 14px;
        }
    </style>
    <script type="text/javascript">
        function printInvoice(invoiceId) {
            // Mở cửa sổ mới và tải PDF từ Spring Boot backend
            var invoiceWindow = window.open('/admin/store/' + invoiceId + '/pdf', '_blank');
            invoiceWindow.onload = function() {
                // Khi PDF đã tải xong, tự động gọi window.print()
                invoiceWindow.print();
            };
        }
    </script>
</head>

<body>

<main class="content px-3 py-4" layout:fragment="main">
    <div class="container-fluid">
        <div class="row">
            <!-- Nội dung trang chính ở bên trái (nếu có) -->
            <div class="col-md-9">
                <div class="card text-center">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <ul class="nav nav-pills card-header-pills" id="navPills">
                            <li class="hoa-don nav-item" th:if="${listInvoice != null}"
                                th:each="invoice,stt : ${listInvoice}">
                                <a th:href="@{/admin/store/invoice-detail/{id}(id=${invoice.id})}"
                                   th:classappend="${invoice.id == activeInvoiceId} ? 'active'"
                                   class="hoa-don-link nav-link">
                                    Hoá đơn [[${stt.index + 1}]]
                                </a>
                                <a href="#" th:onclick="'confirmDelete(event, ' + ${invoice.id} + ')'">
                                    <button type="button" class="nut-close btn-close" aria-label="Close"></button>
                                </a>
                            </li>
                        </ul>
                        <!-- Button to add new Nav item inside nav -->
                        <form id="invoiceForm" th:action="@{/admin/store/add-invoice}" method="post" th:object="${i}">
                                                        <input type="hidden" name="username" th:value="${username}">
                            <button id="showToastButton" type="button" class="btn btn-success"
                                    th:data-invoice-count="${listInvoice.size()}">Thêm hoá đơn
                            </button>
                        </form>
                    </div>
                    <div class="card-body" style="min-height: 370.4px">
                        <div class="mb-3 d-flex justify-content-between">
                            <div class="d-flex">
                                <div class="d-flex align-items-center">
                                    <div class="search-container d-flex align-items-center">
<!--                                        <input type="text" class="form-control flex-grow-1"-->
<!--                                               id="product-search" placeholder="Tìm kiếm sản phẩm..."-->
<!--                                               oninput="showSuggestions()">-->
                                        <button type="button" id="selectProductButton" class="btn btn-primary ms-2">Chọn sản phẩm
                                        </button>
                                        <div id="suggestions" class="suggestions-list"
                                             th:each="detail : ${productDetails.content}"></div>
                                    </div>

                                    <!-- Modal -->
                                    <div class="modal fade" id="productModal" tabindex="-1"
                                         aria-labelledby="productModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-xl">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="productModalLabel">Danh sách sản
                                                        phẩm</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="card-body">
                                                        <form class="row g-3" method="get">
                                                            <!-- Input tìm kiếm -->
                                                            <div class="col-md-4">
                                                                <label class="form-label">Từ khóa</label>
                                                                <input type="text" class="form-control" name="keyword" th:value="${param.keyword}" placeholder="Nhập tên sản phẩm...">
                                                            </div>

                                                            <!-- Khoảng giá -->
                                                            <div class="col-md-4">
                                                                <label class="form-label">Sắp xếp theo</label>
                                                                <div class="d-flex align-items-center">
                                                                    <select class="form-select" name="sort">
                                                                        <option value="">Tất cả</option>
                                                                        <option value="Giá tăng dần"
                                                                                th:selected="${param.sort != null and param.sort.toString() == param.sort.toString()}">Giá tăng dần</option>
                                                                        <option
                                                                                value="Giá giảm dần"
                                                                                th:selected="${param.sort != null and param.sort.toString() == param.sort.toString()}">Giá tăng dần</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <!-- Danh mục -->
                                                            <div class="col-md-4">
                                                                <label class="form-label">Danh mục</label>
                                                                <select class="form-select" name="categoryId">
                                                                    <option value="">Tất cả</option>
                                                                    <option th:each="cate : ${listCate}"
                                                                            th:value="${cate.id}"
                                                                            th:text="${cate.name}"
                                                                            th:selected="${param.categoryId != null and param.categoryId.toString() == cate.id.toString()}">
                                                                    </option>
                                                                </select>
                                                            </div>
                                                            <!-- Màu sắc -->
                                                            <div class="col-md-2">
                                                                <label class="form-label">Màu sắc</label>
                                                                <select class="form-select" name="colorId">
                                                                    <option value="">Tất cả</option>
                                                                    <option th:each="c : ${listColor}" th:value="${c.id}" th:text="${c.name}"
                                                                            th:selected="${param.colorId != null and param.colorId.toString() == c.id.toString()}">
                                                                    </option>
                                                                </select>
                                                            </div>

                                                            <!-- Kích cỡ -->
                                                            <div class="col-md-2">
                                                                <label class="form-label">Kích cỡ</label>
                                                                <select class="form-select" name="sizeId">
                                                                    <option value="">Tất cả</option>
                                                                    <option th:each="size : ${listSize}" th:value="${size.id}" th:text="${size.name}"
                                                                            th:selected="${param.sizeId != null and param.sizeId.toString() == size.id.toString()}">
                                                                    </option>
                                                                </select>
                                                            </div>

                                                            <!-- Kiểu dáng -->
                                                            <div class="col-md-2">
                                                                <label class="form-label">Kiểu dáng</label>
                                                                <select class="form-select" name="styleId">
                                                                    <option value="">Tất cả</option>
                                                                    <option th:each="style : ${listStyle}" th:value="${style.id}" th:text="${style.name}"
                                                                            th:selected="${param.styleId != null and param.styleId.toString() == style.id.toString()}">
                                                                    </option>
                                                                </select>
                                                            </div>

                                                            <!-- Chất liệu -->
                                                            <div class="col-md-2">
                                                                <label class="form-label">Chất liệu</label>
                                                                <select class="form-select" name="materialId">
                                                                    <option value="">Tất cả</option>
                                                                    <option th:each="m : ${listMater}" th:value="${m.id}" th:text="${m.name}"
                                                                            th:selected="${param.materialId != null and param.materialId.toString() == m.id.toString()}">
                                                                    </option>
                                                                </select>
                                                            </div>


                                                            <!-- Vải lót -->
                                                            <div class="col-md-2">
                                                                <label class="form-label">Vải lót</label>
                                                                <select class="form-select" name="liningId">
                                                                    <option value="">Tất cả</option>
                                                                    <option th:each="lining : ${listLining}" th:value="${lining.id}" th:text="${lining.name}"
                                                                            th:selected="${param.liningId != null and param.liningId.toString() == lining.id.toString()}">
                                                                    </option>
                                                                </select>
                                                            </div>

                                                            <!-- Đai mũ -->
                                                            <div class="col-md-2">
                                                                <label class="form-label">Đai mũ</label>
                                                                <select class="form-select" name="beltId">
                                                                    <option value="">Tất cả</option>
                                                                    <option th:each="belt : ${listBelt}" th:value="${belt.id}" th:text="${belt.name}"
                                                                            th:selected="${param.beltId != null and param.beltId.toString() == belt.id.toString()}">
                                                                    </option>
                                                                </select>
                                                            </div>

                                                            <!-- Nút tìm kiếm -->
                                                            <div class="col-md-12 d-flex justify-content-center mt-3">
                                                                <button type="submit" class="btn btn-primary w-auto">Tìm kiếm</button>
                                                            </div>
                                                        </form>

                                                    </div>

                                                    <table class="table">
                                                        <thead>
                                                        <tr>
                                                            <th>STT</th>
                                                            <th>Ảnh</th>
                                                            <th>Mã sản phẩm</th>
                                                            <th>Sản phẩm</th>
                                                            <th>Chất liệu</th>
                                                            <th>Danh mục</th>
                                                            <th>Vải lót</th>
                                                            <th>Đai mũ</th>
                                                            <th>Kiểu dáng</th>
                                                            <th>Số lượng</th>
                                                            <th>Giá</th>
                                                            <th>Hành động</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <!-- Lặp qua danh sách productDetail -->
                                                        <tr th:each="detail, stt : ${productDetails.content}">
                                                            <td>[[${stt.index +1}]]</td>
                                                            <td th:if="${detail.product.images.size() > 0}">
                                                                <img th:src="${detail.product.images[0].imageUrl}"
                                                                     alt="Ảnh sản phẩm"
                                                                     style="width: 80px; height: auto;"/>
                                                            </td>
                                                            <td th:if="${detail.product.images.size() <= 0}">
                                                                <img src="" alt="Ảnh mặc định"
                                                                     style="width: 80px; height: auto;"/>
                                                            </td>
                                                            <td>[[${detail.product.sku}]]-[[${detail.id}]]</td>
                                                            <td>
                                                                <div class="flex-lg-grow-1 ms-3">
                                                                    <h5 class="small mb-0"><a href="#"
                                                                                              class="text-reset">[[${detail.product.name}]]</a>
                                                                    </h5>
                                                                    <span class="small">Màu sắc: [[${detail.color.name}]]</span><br>
                                                                    <span class="small">Kích cỡ: [[${detail.size.name}]]</span>
                                                                </div>
                                                            </td>
                                                            <td>[[${detail.product.material.name}]]</td>
                                                            <td>[[${detail.product.category.name}]]</td>
                                                            <td>[[${detail.product.lining.name}]]</td>
                                                            <td>[[${detail.product.belt.name}]]</td>
                                                            <td>[[${detail.product.style.name}]]</td>
                                                            <td>[[${detail.stock}]]</td>
                                                            <td>
                                                                <span th:if="${detail.product.promotion != null}"
                                                                      style="color: #939393; background-image: url('https://file.hstatic.net/1000306633/file/111_ae69cf24dc964f258349efab9c4ae975.png'); background-size: cover; background-color: initial;">
                                                                    [[${T(com.beehat.service.CurrencyUtil).formatCurrency(detail.price)}]]
                                                                </span>
                                                                <div th:if="${detail.product.promotion != null}">
                                                                <!-- Kiểm tra nếu có discountPercentage -->
                                                                <span th:if="${detail.product.promotion.discountPercentage != null && detail.product.promotion.discountPercentage > 0}">
                                                                    <span th:text="${T(com.beehat.service.CurrencyUtil).formatCurrency(detail.price - (detail.price * detail.product.promotion.discountPercentage / 100))}"></span>
                                                                </span>

                                                                <!-- Kiểm tra nếu có discountAmount -->
                                                                <span th:if="${detail.product.promotion.discountAmount != null && detail.product.promotion.discountAmount > 0}">
                                                                    <span th:text="${T(com.beehat.service.CurrencyUtil).formatCurrency(detail.price - detail.product.promotion.discountAmount)}"></span>
                                                                </span>
                                                                </div>
                                                                <!-- Nếu không có giảm giá -->
                                                                <span th:unless="${detail.product.promotion != null}">
                                                                    [[${T(com.beehat.service.CurrencyUtil).formatCurrency(detail.price)}]]
                                                                </span>
                                                            </td>

                                                            <td colspan="2">
                                                                <form th:action="@{/admin/store/add-product-detail-to-invoice}"
                                                                      method="post">
                                                                    <input type="hidden"
                                                                           th:name="${_csrf.parameterName}"
                                                                           th:value="${_csrf.token}"/>
                                                                    <input th:value="${invoiceId}" name="invoiceId"
                                                                           hidden="hidden">
                                                                    <input th:value="${detail.id}"
                                                                           name="productDetailId" hidden="hidden">
                                                                    <button
                                                                            class="btn btn-primary" type="button"
                                                                            onclick="showAlert(this)"
                                                                            th:data-quantity-product="${detail.stock}">
                                                                        <i class="ph ph-shopping-cart"></i>
                                                                    </button>
                                                                </form>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                    <div th:if="${totalPages <= 0}" class="alert alert-warning">
                                                        Không tìm thấy sản phẩm.
                                                    </div>
                                                    <!-- Hiển thị nút phân trang -->
                                                    <nav aria-label="Page navigation example" th:if="${totalPages > 0}">
                                                        <ul class="pagination">
                                                            <li class="page-item"><a class="page-link"
                                                                                     th:href="@{/admin/store/invoice-detail/{id}(id=${invoiceId},page=${currentPage - 1}, size=${size})}">Previous</a>
                                                            </li>
                                                            <li class="page-item"
                                                                th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                                                th:classappend="${i == currentPage} ? 'active'"><a
                                                                    class="page-link"
                                                                    th:href="@{/admin/store/invoice-detail/{id}(id=${invoiceId},page=${i}, size=${size})}">[[${i
                                                                + 1}]]</a></li>
                                                            <li class="page-item"><a class="page-link"
                                                                                     th:href="@{/admin/store/invoice-detail/{id}(id=${invoiceId},page=${currentPage + 1}, size=${size})}">Next</a>
                                                            </li>
                                                        </ul>
                                                    </nav>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Đóng
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <span class="me-3" th:text="${formattedDate != null ? formattedDate : ''}"></span>
                                <span class="me-3"
                                      th:text="${infoInvoice != null ? 'ID : ' + infoInvoice.id : ''}"></span>
                                <span class="me-3" id="invoice-tracking-number"
                                      th:text="${infoInvoice != null ? infoInvoice.invoiceTrackingNumber : ''}"></span>
                                <span class="badge rounded-pill bg-info" th:if="${infoInvoice != null}">[[${infoInvoice.status} == 0 ? 'Chưa thanh toán':'Đã thanh toán']]</span>
                            </div>
                        </div>
                        <table class="table" style="margin-bottom: 0px">
                            <thead>
                            <tr>
                                <th>STT</th>
                                <th>Ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thành tiền</th>
                                <th>Hành động</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="invoiceDetail,stt : ${listInvoiceDetail}">
                                <td>[[${stt.index+1}]]</td>
                                <td th:if="${invoiceDetail.productDetail.product.images.size() > 0}">
                                    <div class="flex-shrink-0">
                                        <img th:src="${invoiceDetail.productDetail.product.images[0].imageUrl}"
                                             alt="Ảnh sản phẩm" width="35"
                                             class="img-fluid"/>
                                    </div>
                                </td>
                                <td th:if="${invoiceDetail.productDetail.product.images.size() <= 0}">
                                    <div class="flex-shrink-0">
                                        <img src="" alt="Ảnh mặc định" width="35" class="img-fluid"/>
                                    </div>
                                </td>
                                <td th:if="${invoiceDetail.productDetail.status == 1}">
                                    <div class="flex-lg-grow-1 ms-3">
                                        <h6 class="small mb-0"><a href="#" class="text-reset">[[${invoiceDetail.productDetail.product.name}]]</a>
                                        </h6>
                                        <span class="small">Màu sắc: [[${invoiceDetail.productDetail.color.name}]],</span>
                                        <span class="small">Kích cỡ: [[${invoiceDetail.productDetail.size.name}]]</span>
                                    </div>
                                </td>
                                <td th:if="${invoiceDetail.productDetail.status == 2}">
                                    <div class="flex-lg-grow-1 ms-3">
                                        <del class="small mb-0"><a href="#" class="text-reset">[[${invoiceDetail.productDetail.product.name}]]</a>
                                        </del>
                                        <del class="small">Màu sắc: [[${invoiceDetail.productDetail.color.name}]],</del>
                                        <del class="small">Kích cỡ: [[${invoiceDetail.productDetail.size.name}]]</del><br>
                                        <strong class="text-danger">Sản phẩm này đã bị ngừng bán</strong>
                                    </div>
                                </td>
                                    <td>
                                        <form th:action="@{/admin/store/update-quantity}" method="post">
                                        <center>
                                            <input type="hidden" name="ids" th:value="${invoiceDetail.id}"/>
                                            <input class="form-control"
                                                   style="width:60px; text-align: center; align-items: center;border-left: 0;border-bottom: 1px;;border-right: 0;border-top:0;border-radius: 0;padding-right: 2px "
                                                   type="number" name="quantities" th:value="${invoiceDetail.quantity}"
                                                   min="1" step="1" max="1000000" pattern="\d+"
                                                   th:data-quantity-product="${invoiceDetail.productDetail.stock}"
                                                   th:data-quantity-invoice-detail="${invoiceDetail.quantity}"
                                                   onchange="checkQuantityAndSubmit(this)"/>
                                        </center>
                                        </form>
                                    </td>
                                <td>
                                    <span th:if="${invoiceDetail.productDetail.product.promotion != null}"
                                          style="color: #939393; background-image: url('https://file.hstatic.net/1000306633/file/111_ae69cf24dc964f258349efab9c4ae975.png'); background-size: cover; background-color: initial;">
                                                                    [[${T(com.beehat.service.CurrencyUtil).formatCurrency(invoiceDetail.productDetail.price)}]]
                                                                </span>
                                    <div th:if="${invoiceDetail.productDetail.product.promotion != null}">
                                        <!-- Kiểm tra nếu có discountPercentage -->
                                        <span th:if="${invoiceDetail.productDetail.product.promotion.discountPercentage != null && invoiceDetail.productDetail.product.promotion.discountPercentage > 0}">
                                                                    <span th:text="${T(com.beehat.service.CurrencyUtil).formatCurrency(invoiceDetail.discountAmount)}"></span>
                                                                </span>

                                        <!-- Kiểm tra nếu có discountAmount -->
                                        <span th:if="${invoiceDetail.productDetail.product.promotion.discountAmount != null && invoiceDetail.productDetail.product.promotion.discountAmount > 0}">
                                                                    <span th:text="${T(com.beehat.service.CurrencyUtil).formatCurrency(invoiceDetail.discountAmount)}"></span>
                                                                </span>
                                    </div>
                                    <!-- Nếu không có giảm giá -->
                                    <span th:unless="${invoiceDetail.productDetail.product.promotion != null}">
                                                                    [[${T(com.beehat.service.CurrencyUtil).formatCurrency(invoiceDetail.unitPrice)}]]
                                                                </span>
                                </td>
                                <td>[[${T(com.beehat.service.CurrencyUtil).formatCurrency(invoiceDetail.finalPrice)}]]</td>
                                <td>
                                    <button class="btn btn-danger" onclick="deleteProduct(this)"
                                            th:data-delete-url="@{/admin/store/delete-product-from-invoice/{id}(id=${invoiceDetail.id})}">
                                        <i class="ph-bold ph-trash" style="font-size: 17px"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                    </div>

                </div>
            </div>

            <!-- Card thông tin khách hàng ở bên phải -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header"
                         style="min-height: 56.8px; display: grid; place-items: center;font-size: 19px">
                        Thông tin hoá đơn
                    </div>

                    <div class="card-body">
                        <form method="post" th:object="${pay}" th:action="@{/admin/store/pay}">
                            <div class="mb-3">
                                <label class="form-label me-2">Khách Hàng</label>
                                <div class="d-flex align-items-center">
                                    <input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}"
                                           th:value="${_csrf.token}">
                                    <input type="hidden" id="invoiceId" th:value="${invoiceId}">
                                    <select id="customerSelect" class="form-select" onchange="updateCustomerInvoice()">
                                        <option value="">Chọn khách hàng</option>
                                        <option th:each="customer : ${listCustomer}" th:value="${customer.id}"
                                                th:data-invoice-id="${invoiceId}"
                                                th:text="${customer.fullname}+' - '+${customer.phone}"
                                                th:selected="${infoInvoice != null && infoInvoice.customer != null && customer.id == infoInvoice.customer.id}"></option>
                                    </select>
                                    <button th:if="${invoiceId != null}" type="button" class="btn btn-primary ms-2" data-bs-toggle="modal"
                                            data-bs-target="#addCustomerModal">+
                                    </button>
                                </div>
                            </div>
                            <!-- Nhập voucher -->
                            <div class="row">
                                <label class="form-label">Mã Voucher</label>
                                <div class="col-12 d-flex align-items-center">
                                    <select id="voucherSelect" class="form-select" onchange="updateVoucherPreview()">
                                        <option value="">Chọn voucher</option>
                                        <option th:each="voucher : ${listVoucher}" th:value="${voucher.id}"
                                                th:text="${voucher.code}+' - '+${voucher.name}+ ' - ' +${voucher.discountPercentage} + '%'"
                                                th:data-code="${voucher.code}" th:data-name="${voucher.name}"
                                                th:data-discount="${voucher.discountPercentage}"
                                                th:data-description="${voucher.description}"
                                                th:data-quantity="${voucher.quantity}"
                                                th:data-min="${voucher.minOrderValue}"
                                                th:data-max="${voucher.discountMax}"
                                                th:data-startdate="${voucher.startDate}"
                                                th:data-enddate="${voucher.endDate}"
                                                th:selected="${infoInvoice != null && infoInvoice.voucher != null && voucher.id == infoInvoice.voucher.id}"></option>
                                    </select>
                                </div>
                                <!-- Phần hiển thị preview -->
                                <div class="card-body preview-block" style="display: none">
                                    <div class="voucher-card m-1"
                                         style="width: 100%; height: 130px; border-radius: 10px; background: linear-gradient(135deg, #43a047, #76c893); color: #fff; display: flex; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                                        <div class="voucher-left"
                                             style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px;">
                                            <div id="previewName" class="voucher-header"
                                                 style="font-size: 16px; font-weight: bold; text-align: center;">
                                                SUMMER SALE
                                            </div>
                                            <div id="previewDiscount" class="discount-amount"
                                                 style="font-size: 28px; font-weight: bold; color: #ffffff;">25%
                                                OFF
                                            </div>
                                        </div>
                                        <div class="voucher-right"
                                             style="flex: 1; padding: 10px; display: flex; flex-direction: column; justify-content: space-around; background-color: #fff; color: #43a047;">
                                            <div id="previewCode" class="voucher-code"
                                                 style="font-size: 16px; font-weight: bold; background: #43a047; color: #fff; padding: 4px 8px; border-radius: 5px; text-align: center;">
                                                GREEN2023
                                            </div>
                                            <div id="previewQuantity" class="voucher-details"
                                                 style="font-size: 12px; color: #777;">Quantity : 50
                                                purchase.
                                            </div>
                                            <div id="previewDescription" class="voucher-details"
                                                 style="font-size: 12px; color: #777;">Get 25% off on your next
                                                order.
                                            </div>
                                            <div id="previewValidity" class="validity"
                                                 style="font-size: 10px; color: #555; text-align: center;">Valid:
                                                01/06/2023 - 30/06/2023
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table mb-5 mt-3">
                                    <tbody>
                                    <form th:object="${infoInvoice}">
                                        <tr>
                                            <td>Tổng tiền :</td>
                                            <td id="totalPrice" th:if="${infoInvoice != null}" class="text-end"
                                                th:field="*{totalPrice}" th:text="*{T(com.beehat.service.CurrencyUtil).formatCurrency(totalPrice)}"
                                                th:data-totalprice="*{totalPrice}"></td>
                                        </tr>
                                        <tr id="discountRow" style="display: none;">
                                            <td>Giảm giá voucher :</td>
                                            <td id="discountAmount" class="text-end"></td>
                                        </tr>
                                        <tr th:if="${infoInvoice != null and infoInvoice.promotionDiscount != null && infoInvoice.promotionDiscount > 0}" id="discount">
                                            <td>Giảm giá sản phẩm :</td>
                                            <td id="discountAll" class="text-end" th:data-discount-raw-value="*{promotionDiscount}" th:text="*{'-' + T(com.beehat.service.CurrencyUtil).formatCurrency(promotionDiscount)}"></td>
                                        </tr>
                                        <tr th:unless="${infoInvoice != null and infoInvoice.promotionDiscount != null && infoInvoice.promotionDiscount > 0}" id="discount" hidden="hidden">
                                            <td>Giảm giá sản phẩm :</td>
                                            <td id="discountAll" class="text-end" data-discount-raw-value="0"></td>
                                        </tr>

                                        <tr class="bg-light">
                                            <th>Thực thu :</th>
                                            <td class="text-end">
                                            <span id="finalPrice" th:if="${infoInvoice != null}" class="fw-bold" th:data-raw-value="*{finalPrice}"
                                                  th:field="*{finalPrice}" th:text="*{T(com.beehat.service.CurrencyUtil).formatCurrency(finalPrice)}">
                                            </span>
                                            </td>
                                        </tr>
                                    </form>
                                </table>
                            </div>
                            <button type="button" class="btn btn-primary w-100" onclick="pay(this)"
                                    th:data-invoice-details-count="${listInvoiceDetail != null ? listInvoiceDetail.size() : ''}">
                                Thanh toán
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mb-3">
        <!-- Modal hiển thị mã QR và đếm ngược -->
        <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="qrModalLabel">Quét mã thanh toán</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img style="width: 400px" id="qrImage"
                             alt="Mã QR VietQR thanh toán">
                        <p id="countdownText" class="mt-3">Thời gian còn lại: <span
                                id="countdown"></span> giây</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Đóng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" th:object="${kh}" th:action="@{/admin/store/add-new-customer}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="modal-header">
                        <h5 class="modal-title" id="addCustomerModalLabel">Thêm Khách Hàng Mới</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Tên Khách Hàng</label>
                            <input type="text" hidden="hidden" th:value="${invoiceId}" name="invoiceId">
                            <input type="text" class="form-control" th:field="*{fullname}"
                                   placeholder="Nhập tên khách hàng" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số Điện Thoại</label>
                            <input type="tel" class="form-control" th:field="*{phone}" placeholder="Nhập số điện thoại"
                                   required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Lựa chọn phương thức thanh toán</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm" th:action="@{/admin/store/pay}" method="post">
                        <input name="idPayment" th:value="${infoInvoice != null ? infoInvoice.id : ''}" hidden="hidden">
                        <!-- Hiển thị tổng tiền -->
                        <div class="mb-3" th:if="${infoInvoice != null && infoInvoice.totalPrice != null}">
                            <label for="totalAmount" class="form-label">Tổng tiền</label>
                            <input type="text" class="form-control" id="totalAmount" readonly>
                            <input id="totalAmountRaw" name="totalPayment" type="hidden" readonly>
                        </div>
                        <select id="voucherPayment" class="form-select" name="voucherPayment" style="display: none">
                            <option value="">Chọn voucher</option>
                            <option th:each="voucher : ${listVoucher}" th:value="${voucher.id}"
                                    th:text="${voucher.code} + ' - ' + ${voucher.name} + ' - ' + ${voucher.discountPercentage} + '%'"
                                    th:selected="${infoInvoice != null && infoInvoice.voucher != null && voucher.id == infoInvoice.voucher.id}">
                            </option>
                        </select>
                        <!-- Lựa chọn phương thức thanh toán -->
                        <div class="mb-3" th:if="${infoInvoice != null}">
                            <label class="form-label me-2">Phương thức thanh toán</label>
                            <div class="d-flex align-items-center">
                                <select class="form-control flex-grow-1" id="paymentMethod" name="methodPayment">
                                    <option value="" hidden="hidden">Chọn phương thức thanh toán</option>
                                    <option th:each="payment : ${listPayment}"
                                            th:text="${payment.name}"
                                            th:value="${payment.id}"></option>
                                </select>
                            </div>

                            <!-- Bảng tính toán tiền mặt -->
                            <div id="cashCalculation"
                                 style="display: none; margin-top: 20px;">
                                <label class="form-label">Bảng tính toán tiền mặt</label>
                                <div>
                                    <label class="form-label">Tiền mặt khách đưa:</label>
                                    <input type="number" id="cashGiven" class="form-control"
                                           oninput="calculateChange()">
                                </div>
                                <div>
                                    <label class="form-label">Tiền thừa trả khách:</label>
                                    <input type="text" class="form-control" id="changeAmount" readonly>
                                </div>
                                <div>
                                    <label class="form-label">Tiền khách thiếu:</label>
                                    <input type="text" class="form-control" id="changeAmount1" readonly>
                                </div>
                            </div>
                            <!-- Hiển thị mã QR và tiền chuyển khoản khi chọn Chuyển khoản -->
                            <div id="bankTransferDetails" style="display: none; margin-top: 20px">
                                <div class="mb-3">
                                    <label class="form-label">Mã QR Chuyển khoản</label>
                                    <div style="text-align: center;align-items: center">
                                        <!-- Thêm mã QR tại đây, có thể là hình ảnh QR code hoặc iframe nếu từ một nguồn khác -->
                                        <img src="" alt="QR Code" id="qrCode" style="width: 300px;">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="transferAmount" class="form-label">Số tiền chuyển khoản</label>
                                    <input type="text" class="form-control" id="transferAmount" readonly>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-primary"
                                    th:data-invoice-submit-payment="${infoInvoice != null ? infoInvoice.id : null}"
                                    onclick="submitPayment(this)">Xác nhận thanh toán
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        const products = [
            {
                name: "Mũ thời trang 1",
                image: "https://yt3.ggpht.com/ytc/AIdro_lKx-Sdd8jmDaBecmYHwC_5J4W9qcRPN4qbalefZi0g9Q=s88-c-k-c0x00ffffff-no-rj"
            },
            {
                name: "Mũ thời trang 2",
                image: "https://yt3.ggpht.com/ytc/AIdro_lKx-Sdd8jmDaBecmYHwC_5J4W9qcRPN4qbalefZi0g9Q=s88-c-k-c0x00ffffff-no-rj"
            },
            {
                name: "Mũ thời trang 3",
                image: "https://yt3.ggpht.com/ytc/AIdro_lKx-Sdd8jmDaBecmYHwC_5J4W9qcRPN4qbalefZi0g9Q=s88-c-k-c0x00ffffff-no-rj"
            },
            {
                name: "Mũ thời trang 4",
                image: "https://yt3.ggpht.com/ytc/AIdro_lKx-Sdd8jmDaBecmYHwC_5J4W9qcRPN4qbalefZi0g9Q=s88-c-k-c0x00ffffff-no-rj"
            }
        ];

        // Hàm hiển thị gợi ý
        function showSuggestions() {
            const input = document.getElementById("product-search");
            const suggestionsContainer = document.getElementById("suggestions");
            const query = input.value.toLowerCase();
            // Xóa gợi ý cũ
            suggestionsContainer.innerHTML = "";
            suggestionsContainer.style.display = "none";

            if (query) {
                const filteredProducts = products.filter(product => product.name.toLowerCase().includes(query));

                if (filteredProducts.length > 0) {
                    suggestionsContainer.style.display = "block";

                    filteredProducts.forEach(product => {
                        const suggestionItem = document.createElement("div");
                        suggestionItem.className = "suggestion-item";
                        suggestionItem.onclick = () => alert(`Bạn đã chọn sản phẩm: ${product.name}`);

                        suggestionItem.innerHTML = `
                      <img src="${product.image}" alt="${product.name}" class="suggestion-image">
                      <span class="suggestion-text">${product.name}</span>
                  `;

                        suggestionsContainer.appendChild(suggestionItem);
                    });
                }
            }
        }
        // hàm update số lượng sản phẩm
        function checkQuantityAndSubmit(inputElement) {
            const form = inputElement.form;
            const quantity = parseInt(inputElement.value);
            const maxQuantity = parseInt(inputElement.getAttribute('data-quantity-product')); // Số lượng trong kho
            const lastQuantity = parseInt(inputElement.getAttribute('data-quantity-invoice-detail')); // Số lượng trong hóa đơn hiện tại

            if (isNaN(quantity) ||quantity <= 0) {
                alert("Số lượng sản phẩm không hợp lệ !")
                inputElement.value = lastQuantity;
                form.onsubmit = function () {
                    return false; // Ngăn không cho form được submit
                };
                return;
            }
            // Kiểm tra số lượng tồn kho sau khi thêm số lượng mong muốn vào hóa đơn
            if (quantity > maxQuantity + lastQuantity) {
                alert("Số lượng sản phẩm trong kho không đủ!");
                inputElement.value = lastQuantity; // Đặt lại giá trị trước đó
                return;
            }

            // Nếu số lượng hợp lệ, cho phép form submit
            form.submit();
        }

        // Mở modal chọn phương thức thanh toán và set tổng tiền
        function openPaymentModal() {
            var finalPriceElement = document.getElementById('finalPrice');
            var finalPrice = finalPriceElement.textContent; // Hoặc dùng innerText
            const finalPriceRaw = finalPriceElement.getAttribute("data-raw-value")
            const totalAmount = document.getElementById("totalAmount");
            const totalAmountRaw = document.getElementById("totalAmountRaw");
            totalAmount.value = finalPrice;
            totalAmountRaw.value = finalPriceRaw;
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }

        // Gửi dữ liệu thanh toán, là hàm xác nhận thanh toán
        function submitPayment(button) {
            const paymentMethod = document.getElementById("paymentMethod").value;
            if (!paymentMethod) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thanh toán thất bại',
                    text: 'Không thể thanh toán vì bạn chưa chọn phương thức thanh toán !',
                });
                return; // Dừng lại không thực hiện tiếp
            }

            Swal.fire({
                title: 'Bạn có chắc chắn muốn thanh toán?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy',
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = button.closest("form");
                    // Tạo đối tượng FormData từ form
                    const formData = new FormData(form);
                    fetch('/admin/store/pay', {
                        method: 'POST',
                        body: formData,
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(errorData => {
                                    throw new Error(errorData.message || "Lỗi không xác định");
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thanh toán thành công',
                                text: 'Hóa đơn đã được lưu!',
                            }).then(() => {
                                printInvoice(data.invoiceId); // Gọi hàm in sau khi server trả về ID hóa đơn mới.
                                window.location.href = '/admin/store/index';
                            });
                        })
                        .catch(error => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Thanh toán thất bại',
                                text: error.message,
                            });
                        });
                }
            });


            // Đóng modal sau khi thanh toán thành công
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
        }
    </script>
    <script>
        //hàm chạy khi bấm nút thanh toán
        function pay(button) {
            const form = button.closest("form");
            let invoiceInput = "";
            let customerSelect = "";
            let element = document.querySelector('strong.text-danger');
            // Kiểm tra số lượng hóa đơn hiện có
            const currentInvoiceDetails = parseInt(button.getAttribute('data-invoice-details-count'));

            if (form) {
                invoiceInput = form.querySelector("input[id='invoiceId']").value;
                customerSelect = form.querySelector("select[id='customerSelect']").value;
            } else {
                console.error("Form element not found.");
            }
            // Kiểm tra nếu invoiceId không tồn tại hoặc rỗng
            if (invoiceInput == "") {
                Swal.fire({
                    icon: 'error',
                    title: 'Thanh toán thất bại',
                    text: 'Không thể thanh toán vì bạn chưa chọn hoá đơn!',
                });
                return; // Dừng lại không thực hiện tiếp
            }
            if (currentInvoiceDetails == 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thanh toán thất bại',
                    text: 'Không thể thanh toán vì hoá đơn không có sản phẩm nào !',
                });
                return; // Dừng lại không thực hiện tiếp
            }
            if (element){
                Swal.fire({
                    icon: 'error',
                    title: 'Thanh toán thất bại',
                    text: 'Không thể thanh toán vì hoá đơn có sản phẩm ngừng bán !',
                });
                return; // Dừng lại không thực hiện tiếp
            }
            if (customerSelect == "") {
                Swal.fire({
                    icon: 'error',
                    title: 'Thanh toán thất bại',
                    text: 'Không thể thanh toán vì bạn chưa chọn khách hàng!',
                });
                return; // Dừng lại không thực hiện tiếp
            }
            Swal.fire({
                title: 'Bạn có chắc chắn muốn thanh toán?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    const selectElement = document.getElementById('paymentMethod');
                    const selectValue = document.getElementById("voucherSelect").value;
                    console.log(selectValue)
                    if (!selectValue){
                        const finalPriceElement = document.getElementById('finalPrice');
                        const totalPriceElement = document.getElementById("totalPrice");
                        const totalPrice = totalPriceElement.getAttribute("data-totalprice");
                        const discountAllRaw = document.getElementById("discountAll");
                        const discountAll = discountAllRaw.getAttribute("data-discount-raw-value");
                        const finalPrice = totalPrice - discountAll;
                        finalPriceElement.setAttribute("data-raw-value", finalPrice);
                    }
                    selectElement.selectedIndex = 0; // Reset về phần tử đầu tiên
                    const cashCalculationDiv = document.getElementById("cashCalculation");
                    const bankTransferDetailsDiv = document.getElementById("bankTransferDetails");
                    cashCalculationDiv.style.display = "none";
                    bankTransferDetailsDiv.style.display = "none";
                    openPaymentModal();// comment nhiều ở nút thanh toán cũ nhất là phần hiện qr rồi in hoá đơn !
                }
            });
        }
        // hàm xoá sản phẩm
        function deleteProduct(button) {
            const deleteUrl = button.getAttribute('data-delete-url');

            Swal.fire({
                title: 'Bạn có chắc là muốn xoá sản phẩm này khỏi giỏ hàng?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = deleteUrl; // Chuyển hướng đến URL xóa khi đồng ý
                }
            });
        }
        // hàm thêm sản phẩm vào hoá đơn
        function showAlert(button) {
            // Lấy giá trị invoiceId từ input trong form
            const invoiceId = button.closest("form").querySelector("input[name='invoiceId']").value;
            const quantity = button.getAttribute('data-quantity-product');
            // Kiểm tra nếu invoiceId không tồn tại hoặc rỗng
            if (!invoiceId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thêm thất bại',
                    text: 'Không thể thêm sản phẩm vì bạn chưa chọn hoá đơn!',
                });
                return; // Dừng lại không thực hiện tiếp
            }
            if (quantity <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thêm thất bại',
                    text: 'Không thể thêm sản phẩm vì số lượng sản phẩm không đủ !',
                });
                return; // Dừng lại không thực hiện tiếp
            }
            Swal.fire({
                title: 'Bạn có chắc chắn muốn thêm sản phẩm?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Nếu đồng ý, hiển thị thông báo Toast
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                    });
                    Toast.fire({
                        icon: "success",
                        title: "Thêm thành công"
                    });

                    // Chờ toast hoàn thành rồi submit form
                    setTimeout(() => {
                        const form = button.closest("form");
                        form.submit(); // Submit form mà không cần click lại button
                    }, 1500);
                }
            });
        }
    </script>

    <script>
        //hàm cập nhật thông tin khách hàng
        function updateCustomerInvoice() {
            let customerId = document.getElementById("customerSelect").value;
            let invoiceId = document.getElementById("invoiceId").value;
            let csrfToken = document.getElementById("csrfToken").value;

            if (customerId && invoiceId) {
                let formData = new FormData();
                formData.append("invoiceId", invoiceId);
                formData.append("customerId", customerId);

                fetch("/admin/store/updateCustomer", {
                    method: "POST",
                    headers: {
                        "X-CSRF-TOKEN": csrfToken // Thêm CSRF token vào header
                    },
                    body: formData
                })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url; // Redirect về trang chi tiết hóa đơn
                        } else {
                            return response.text();
                        }
                    })
                    .then(data => {
                        if (data) alert(data); // Hiển thị thông báo kết quả
                    })
                    .catch(error => console.error("Error:", error));
            }
        }
        //hàm kiểm tra thay đổi của ô select phương thức thanh toán
        document.getElementById("paymentMethod").addEventListener("change", function () {
            const selectedMethod = this.options[this.selectedIndex].text;
            const cashCalculationDiv = document.getElementById("cashCalculation");
            const bankTransferDetailsDiv = document.getElementById("bankTransferDetails");
            const finalPriceElement = parseInt(document.getElementById("totalAmount").value.replace(/[^\d]/g, "") || 0);
            const finalPrice1 = document.getElementById('finalPrice');
            const finalPriceRaw = finalPrice1.getAttribute("data-raw-value")
            if (selectedMethod === "Tiền mặt") {
                calculateChange();
                cashCalculationDiv.style.display = "block";
                bankTransferDetailsDiv.style.display = "none";
                document.getElementById("changeAmount1").innerText = finalPriceElement.toLocaleString("vi-VN", {
                    style: "currency",
                    currency: "VND"
                });
            } else if (selectedMethod === "Chuyển khoản") {

                // Lấy thẻ img theo id
                var qrImageElement = document.getElementById('qrCode');
                // Đặt giá trị src

                qrImageElement.setAttribute('src', 'https://img.vietqr.io/image/MB-2234686869-compact2.png?amount=' + finalPriceRaw + '&addInfo=Thanh toan hoa don : ' + document.getElementById("invoice-tracking-number").textContent + '&accountName=NGUYEN THE QUANG');
                console.log(qrImageElement);
                cashCalculationDiv.style.display = "none";
                bankTransferDetailsDiv.style.display = "block";
                document.getElementById("transferAmount").value = finalPriceElement.toLocaleString("vi-VN", {
                    style: "currency",
                    currency: "VND"
                });
            } else {
                cashCalculationDiv.style.display = "none";
                bankTransferDetailsDiv.style.display = "none";
            }
        });


        function calculateChange() {
            // Lấy giá trị totalAmount từ thuộc tính data-total-amount
            const finalPriceElement = parseInt(document.getElementById("totalAmount").value.replace(/[^\d]/g, "") || 0);
            const cashGiven = parseInt(document.getElementById("cashGiven").value || 0);
            const change = cashGiven - finalPriceElement;
            const change1 = finalPriceElement - cashGiven;
            // Cập nhật hiển thị tiền thối lại
            document.getElementById("changeAmount").value = change >= 0 ? change : "0";
            document.getElementById("changeAmount1").value = change1 > 0 ? change1 : "0";
        }

        //jquery select2 dùng để tìm kiếm khách hàng
        $(document).ready(function () {
            $('#customerSelect').select2({
                placeholder: "Tìm kiếm khách hàng",
                allowClear: true
            });
        });
    </script>
    <script>
        //jquery select2 dùng để tìm kiếm voucher
        $(document).ready(function () {
            $('#voucherSelect').select2({
                placeholder: "Chọn voucher",
                allowClear: true
            });

        });

        function checkVoucher(){
            const finalPrice = document.getElementById('finalPrice');
            const finalPriceRaw = finalPrice.getAttribute("data-raw-value") || 0
            const select = document.getElementById("voucherSelect");
            const selectedOption = select.options[select.selectedIndex];
            const optionData = selectedOption.dataset;
            const discountAllRaw = document.getElementById("discountAll");
            // Kiểm tra minValue có hợp lệ không
            const minValue = optionData.min ? parseInt(optionData.min) : 0;
            if (finalPriceRaw >= minValue) {
                return true;
            } else {
                return false;
            }
        }
        function updateVoucherPreview() {
            if (!checkVoucher()) {
                Swal.fire({
                    icon: 'error',
                    title: 'Thất bại',
                    text: 'Hoá đơn của bạn chưa đạt giá trị tối thiểu!',
                });
                $('#voucherSelect').val(null).trigger('change');
                return; // Dừng lại không thực hiện tiếp
            }

            const select = document.getElementById("voucherSelect");
            const selectValue = select.value;
            const selectedOption = select.options[select.selectedIndex];
            const optionData = selectedOption.dataset;
            const selectPayment = document.getElementById("voucherPayment");
            const maxValue = optionData.max || 0;
            selectPayment.value = selectValue;
            // Lấy phần tử giá trị
            const totalPriceElement = document.getElementById("totalPrice");
            const discountRow = document.getElementById("discountRow");
            const discountAmountElement = document.getElementById("discountAmount");
            const finalPriceElement = document.getElementById("finalPrice");
            const discountAllRaw = document.getElementById("discountAll");

            // Giá trị gốc của hóa đơn (tổng tiền - giảm giá chung)
            const totalPrice = parseInt(totalPriceElement.getAttribute("data-totalprice")) || 0;
            const discountAll = parseInt(discountAllRaw.getAttribute("data-discount-raw-value")) || 0;
            const baseFinalPrice = totalPrice - discountAll;

            // Nếu không có voucher được chọn
            if (!selectValue) {
                finalPriceElement.setAttribute("data-raw-value", baseFinalPrice);
                finalPriceElement.innerText = baseFinalPrice.toLocaleString("vi-VN", {
                    style: "currency",
                    currency: "VND",
                });
                discountRow.style.display = "none";
                document.querySelector(".card-body .preview-block").style.display = "none";
                return;
            }

            // Áp dụng giảm giá từ voucher
            const discountPer = parseInt(selectedOption.getAttribute("data-discount")) || 0;
            const discountAmount = Math.min(
                Math.floor((baseFinalPrice * discountPer) / 100),
                maxValue
            );
            const lastPrice = baseFinalPrice - discountAmount;

            // Cập nhật giá trị hiển thị
            discountRow.style.display = "table-row";
            discountAmountElement.innerText = `-${discountAmount.toLocaleString("vi-VN", {
                style: "currency",
                currency: "VND",
            })}`;
            finalPriceElement.innerText = lastPrice.toLocaleString("vi-VN", {
                style: "currency",
                currency: "VND",
            });
            finalPriceElement.setAttribute("data-raw-value", lastPrice);

            // Hiển thị thông tin voucher trong phần preview
            const previewContainer = document.querySelector(".card-body .preview-block");
            previewContainer.style.display = "block";

            document.getElementById("previewName").innerText = optionData.name || "Voucher";
            document.getElementById("previewCode").innerText = optionData.code || "CODE";
            document.getElementById("previewDiscount").innerText = `${discountPer}% OFF`;
            document.getElementById("previewQuantity").innerText = `Quantity: ${optionData.quantity || "0"}`;
            document.getElementById("previewDescription").innerText = optionData.description || "Mô tả";
            document.getElementById("previewValidity").innerText = `Valid: ${
                optionData.startdate ? new Date(optionData.startdate).toLocaleDateString() : "--"
            } - ${
                optionData.enddate ? new Date(optionData.enddate).toLocaleDateString() : "--"
            }`;
        }


    </script>
    <script src="/admin/store/script.js"></script>
    <script>
        document.getElementById('showToastButton').addEventListener('click', function (event) {
            // Kiểm tra số lượng hóa đơn hiện có
            const maxInvoices = 6;
            const currentInvoices = parseInt(document.getElementById('showToastButton').getAttribute('data-invoice-count'));
            console.log(currentInvoices);
            if (currentInvoices >= maxInvoices) {
                // Hiển thị thông báo lỗi nếu vượt quá giới hạn
                Swal.fire({
                    icon: 'error',
                    title: 'Thêm thất bại',
                    text: 'Không được phép có nhiều hơn 6 hóa đơn.',
                    showConfirmButton: true
                });
            } else {
                // Hiển thị hộp thoại xác nhận nếu chưa đạt giới hạn
                Swal.fire({
                    title: 'Bạn có chắc chắn muốn thêm hóa đơn?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Hủy',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        const Toast = Swal.mixin({
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 1500,
                            timerProgressBar: true,
                            didOpen: (toast) => {
                                toast.onmouseenter = Swal.stopTimer;
                                toast.onmouseleave = Swal.resumeTimer;
                            }
                        });
                        Toast.fire({
                            icon: "success",
                            title: "Thêm thành công"
                        });

                        setTimeout(() => {
                            document.getElementById('invoiceForm').submit();
                        }, 1500);
                    }
                });
            }
        });

        // Hàm xác nhận xóa
        function confirmDelete(event, id) {
            // Ngăn không cho thực hiện hành động mặc định
            event.preventDefault();

            // Hiển thị SweetAlert
            Swal.fire({
                title: 'Bạn có chắc chắn muốn xóa?',
                text: "Hành động này không thể hoàn tác!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Nếu đồng ý, hiển thị thông báo Toast
                    const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 1500,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                    });
                    Toast.fire({
                        icon: "success",
                        title: "Xoá thành công"
                    });
                    // Nếu người dùng xác nhận, điều hướng đến URL xóa
                    setTimeout(() => {
                        window.location.href = `/admin/store/delete-invoice/${id}`;
                    }, 1500);
                }
            });
        }
        document.addEventListener("DOMContentLoaded", function () {
            const selectProductButton = document.getElementById("selectProductButton");
            const invoiceIdInput = document.getElementById("invoiceId"); // Giả sử bạn có input chứa id hóa đơn
            const productModal = new bootstrap.Modal(document.getElementById('productModal')); // Tạo instance modal Bootstrap

            selectProductButton.addEventListener("click", function (event) {
                // Kiểm tra xem đã chọn hóa đơn hay chưa
                if (!invoiceIdInput || !invoiceIdInput.value.trim()) {
                    showAlert(); // Hiển thị thông báo SweetAlert
                } else {
                    productModal.show(); // Mở modal nếu hợp lệ
                }
            });

            // Hàm hiển thị thông báo SweetAlert
            function showAlert() {
                Swal.fire({
                    icon: 'warning',
                    title: 'Vui lòng chọn hóa đơn trước!',
                    text: 'Bạn cần chọn hóa đơn trước khi thêm sản phẩm.',
                    confirmButtonText: 'OK',
                });
            }
        });

        // $(document).ready(function() {
        //     // Khi modal mở, thêm padding vào body nếu cần
        //     $('#paymentModal').on('shown.bs.modal', function() {
        //         $('body').css('padding-right', ''); // Xóa padding-right nếu có
        //     });
        //
        //     // Khi modal đóng, đảm bảo padding và margin không bị thay đổi
        //     $('#paymentModal').on('hidden.bs.modal', function() {
        //         $('body').css('padding-right', ''); // Xóa padding-right
        //         $('body').css('margin', ''); // Xóa margin nếu có
        //     });
        // });
    </script>
</main>
</body>


</html>